---
phase: 02-data-model
plan: 02
type: execute
---

<objective>
Create Row Level Security (RLS) policies for all tables to ensure data isolation per household.

Purpose: Secure data access so users can only see/modify their own household's data.
Output: RLS migration file with policies for all 6 tables.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-model/02-01-PLAN.md

**Prior plan context:** Plan 02-01 creates the base tables

**RLS Strategy:**
- Need to link Supabase auth.users to households
- Add user_id column to households OR create a separate user_households junction table
- Decision: Add owner_id (uuid fk to auth.users) to households for simplicity - one user owns each household
- Profiles, tracked_titles, schedule_entries all reference household_id - policy checks household ownership
- tv_progress references profile_id - policy checks profile belongs to user's household
- episode_blurbs are shared (no RLS needed - public read, no user writes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add owner_id to households and create RLS migration</name>
  <files>web/supabase/migrations/YYYYMMDDHHMMSS_add_rls_policies.sql</files>
  <action>
    1. Create new migration file
    2. Add owner_id column to households: ALTER TABLE households ADD COLUMN owner_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL
    3. Enable RLS on all tables: ALTER TABLE [table] ENABLE ROW LEVEL SECURITY
    4. Create helper function to get user's household_id:
       CREATE OR REPLACE FUNCTION get_user_household_id()
       RETURNS uuid AS $$
         SELECT id FROM households WHERE owner_id = auth.uid()
       $$ LANGUAGE sql SECURITY DEFINER STABLE;
    5. Households policies:
       - SELECT: owner_id = auth.uid()
       - INSERT: owner_id = auth.uid()
       - UPDATE: owner_id = auth.uid()
       - DELETE: owner_id = auth.uid()
    6. Profiles policies:
       - SELECT: household_id = get_user_household_id()
       - INSERT: household_id = get_user_household_id()
       - UPDATE: household_id = get_user_household_id()
       - DELETE: household_id = get_user_household_id()
    7. tracked_titles policies: same pattern as profiles
    8. schedule_entries policies: same pattern as profiles
    9. tv_progress policies:
       - Need to join through profile to check household
       - SELECT: profile_id IN (SELECT id FROM profiles WHERE household_id = get_user_household_id())
       - INSERT/UPDATE/DELETE: same pattern
    10. episode_blurbs: Enable RLS but allow public read (no policies needed for now - future write policies if AI generation added)
  </action>
  <verify>cat web/supabase/migrations/*rls*.sql shows RLS enabled on all tables with appropriate policies</verify>
  <done>RLS migration exists with enable statements for all tables and SELECT/INSERT/UPDATE/DELETE policies for user-owned data</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types with owner_id</name>
  <files>web/lib/database.types.ts</files>
  <action>
    1. Add owner_id: string to Household Row type
    2. Add owner_id: string to Household Insert type (required)
    3. Add owner_id?: string to Household Update type (optional)
    4. Ensure types still compile
  </action>
  <verify>tsc --noEmit in web/ passes</verify>
  <done>Household type includes owner_id field</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RLS migration file exists
- [ ] RLS enabled on all 6 tables
- [ ] Policies exist for households, profiles, tracked_titles, schedule_entries, tv_progress
- [ ] Helper function get_user_household_id() defined
- [ ] TypeScript types updated with owner_id
</verification>

<success_criteria>
- All tables have RLS enabled
- User can only access their own household's data
- TypeScript types match updated schema
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model/02-02-SUMMARY.md`
</output>
