---
phase: 02-data-model
plan: 04
type: execute
---

<objective>
Create profile picker page for selecting which profile to use.

Purpose: Allow household members to select their profile before accessing the guide, enabling per-profile progress tracking.
Output: /app/profiles/select route with profile grid and client-side profile state management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/02-data-model/02-03-PLAN.md

@web/app/app/layout.tsx
@web/lib/supabase/server.ts

**Prior plan context:**
- Plan 02-03 creates household service helpers
- Phase 1 established protected /app routes with auth check in layout

**Profile selection strategy:**
- Store active profile ID in localStorage (simple, works without extra DB)
- Context provider wraps /app routes to provide active profile
- Profile picker shows on first visit or when no profile selected
- Redirect to /app/profiles/select if no active profile

**From SPEC.md Profile Picker:**
- Route: /app/profiles/select
- Goal: choose profile to load per-profile schedule + progress
- UI: Grid of avatars
- Acceptance: Selecting sets activeProfileId and routes to /app/guide
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile context provider</name>
  <files>web/lib/contexts/profile-context.tsx</files>
  <action>
    1. Create ProfileContext with:
       - activeProfileId: string | null
       - activeProfile: Profile | null
       - setActiveProfile: (profileId: string) => void
       - clearActiveProfile: () => void
       - isLoading: boolean
    2. ProfileProvider component:
       - On mount, read profileId from localStorage
       - If profileId exists, fetch profile from Supabase to verify it still exists
       - Expose context values
       - setActiveProfile saves to localStorage and updates state
    3. Export useProfile hook that throws if used outside provider
    4. Use 'use client' directive
  </action>
  <verify>tsc --noEmit in web/ passes</verify>
  <done>ProfileContext exports ProfileProvider and useProfile hook</done>
</task>

<task type="auto">
  <name>Task 2: Create profile picker page</name>
  <files>web/app/app/profiles/select/page.tsx, web/components/profile-card.tsx</files>
  <action>
    1. Create profile-card.tsx component:
       - Props: profile (Profile type), onSelect callback, isActive boolean
       - Display avatar (placeholder colored circle with initial if no avatar), name
       - Maturity level badge (optional subtle indicator)
       - Hover/focus states for selection
       - Dark theme styling consistent with existing app
    2. Create /app/profiles/select/page.tsx:
       - Server component that fetches profiles for current user's household
       - Use getCurrentHousehold and getHouseholdProfiles from services
       - Render ProfileSelectionClient with profiles data
    3. Create ProfileSelectionClient (client component):
       - Grid layout of ProfileCard components
       - On card click: call setActiveProfile, then router.push('/app/guide')
       - Include "Manage Profiles" link (disabled/placeholder for now)
    4. Style: Centered grid, large cards for easy selection, matches dark theme
  </action>
  <verify>npm run build in web/ passes</verify>
  <done>Profile picker page renders grid of profiles and navigates to /app/guide on selection</done>
</task>

<task type="auto">
  <name>Task 3: Integrate profile provider into app layout</name>
  <files>web/app/app/layout.tsx</files>
  <action>
    1. Wrap children with ProfileProvider
    2. Add logic to redirect to /app/profiles/select if no active profile (but not if already on that route)
    3. This can be done in a client component wrapper that checks useProfile
    4. Alternative: Check in each protected page - simpler for now, redirect from /app/page.tsx if no profile
  </action>
  <verify>npm run dev - navigating to /app redirects to profile selection if no profile active</verify>
  <done>App layout includes ProfileProvider and handles profile-less state</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Profile selection flow with context-based state management</what-built>
  <how-to-verify>
    1. Run: npm run dev (in web/)
    2. Visit: http://localhost:3000/app
    3. Should redirect to /app/profiles/select (since no profile selected)
    4. See profile grid with at least "Me" profile (from auto-provisioning)
    5. Click a profile card
    6. Should navigate to /app/guide (or /app if guide doesn't exist yet)
    7. Refresh page - should stay on /app (profile remembered in localStorage)
    8. Clear localStorage, refresh - should redirect back to profile select
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ProfileContext provides active profile state
- [ ] Profile picker page renders profile grid
- [ ] Selecting profile stores in localStorage and navigates
- [ ] App layout wraps with ProfileProvider
- [ ] Profile-less state handled with redirect
</verification>

<success_criteria>
- Profile selection flow works end-to-end
- Profile persists across page refreshes
- Clear selection returns to picker
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model/02-04-SUMMARY.md`
</output>
