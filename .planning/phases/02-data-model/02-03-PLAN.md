---
phase: 02-data-model
plan: 03
type: execute
---

<objective>
Auto-provision household and default profile when user signs up.

Purpose: Ensure every authenticated user has a household and at least one profile so they can immediately use the app.
Output: Database trigger that creates household + default profile on auth.users insert.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-model/02-01-PLAN.md
@.planning/phases/02-data-model/02-02-PLAN.md

**Prior plan context:**
- Plan 02-01 creates tables
- Plan 02-02 adds RLS with owner_id on households

**Provisioning strategy:**
- Supabase trigger on auth.users INSERT
- Creates household with owner_id = new user id
- Creates default profile named "Me" with adult maturity level
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trigger for auto-provisioning</name>
  <files>web/supabase/migrations/YYYYMMDDHHMMSS_auto_provision_household.sql</files>
  <action>
    1. Create new migration file
    2. Create function handle_new_user():
       ```sql
       CREATE OR REPLACE FUNCTION handle_new_user()
       RETURNS trigger AS $$
       DECLARE
         new_household_id uuid;
       BEGIN
         -- Create household for new user
         INSERT INTO public.households (name, owner_id)
         VALUES ('My Household', NEW.id)
         RETURNING id INTO new_household_id;

         -- Create default profile
         INSERT INTO public.profiles (household_id, name, maturity_level)
         VALUES (new_household_id, 'Me', 'adult');

         RETURN NEW;
       END;
       $$ LANGUAGE plpgsql SECURITY DEFINER;
       ```
    3. Create trigger on auth.users:
       ```sql
       CREATE TRIGGER on_auth_user_created
         AFTER INSERT ON auth.users
         FOR EACH ROW EXECUTE FUNCTION handle_new_user();
       ```
    4. Grant necessary permissions for the function to insert into public tables
  </action>
  <verify>cat web/supabase/migrations/*provision*.sql shows trigger and function definition</verify>
  <done>Migration exists with handle_new_user function and on_auth_user_created trigger</done>
</task>

<task type="auto">
  <name>Task 2: Create household service helpers</name>
  <files>web/lib/services/household.ts</files>
  <action>
    1. Create household service file
    2. Export async function getCurrentHousehold(supabase): fetches household where owner_id = current user
    3. Export async function getHouseholdProfiles(supabase, householdId): fetches all profiles for a household
    4. Export async function getActiveProfile(supabase, profileId): fetches single profile by id (for session)
    5. Use proper TypeScript types from database.types.ts
    6. Handle errors with meaningful messages
  </action>
  <verify>tsc --noEmit in web/ passes</verify>
  <done>household.ts exports getCurrentHousehold, getHouseholdProfiles, getActiveProfile functions with proper types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Trigger migration file exists
- [ ] handle_new_user function creates household + default profile
- [ ] Trigger fires on auth.users INSERT
- [ ] Service helpers compile without TypeScript errors
</verification>

<success_criteria>
- New user signup auto-creates household and profile
- Service helpers provide typed access to household data
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model/02-03-SUMMARY.md`
</output>
