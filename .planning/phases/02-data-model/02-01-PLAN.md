---
phase: 02-data-model
plan: 01
type: execute
---

<objective>
Create Supabase database schema with all MVP tables and indexes.

Purpose: Establish the data foundation for household, profiles, library, schedule, and progress tracking.
Output: Migration file applied to Supabase, TypeScript types generated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Tech stack available:** Next.js 16, Supabase SSR, Tailwind v4, shadcn/ui, TanStack Query
**Established patterns:** Server/client Supabase clients in lib/supabase/

**Schema from SPEC.md:**
- households: id, name, created_at
- profiles: id, household_id, name, avatar, maturity_level (kids/teen/adult), pin_hash (nullable)
- tracked_titles: id, household_id, tmdb_id, media_type (tv|movie), added_at
- schedule_entries: id, household_id, profile_id, weekday (0-6), slot_order, tracked_title_id, enabled
- tv_progress: id, profile_id, tracked_title_id, season_number, episode_number, updated_at
- episode_blurbs: id, series_tmdb_id, season_number, episode_number, blurb_text, source, updated_at

**Indexes needed:**
- schedule_entries (profile_id, weekday, slot_order)
- tv_progress (profile_id, tracked_title_id)
- tracked_titles (household_id, media_type)
- episode_blurbs (series_tmdb_id, season_number, episode_number)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase CLI and create migration</name>
  <files>web/supabase/config.toml, web/supabase/migrations/YYYYMMDDHHMMSS_create_mvp_tables.sql</files>
  <action>
    1. Initialize Supabase in web/ directory: `npx supabase init`
    2. Create migration file with all MVP tables:
       - Use UUID primary keys with gen_random_uuid() default
       - households: id, name (text not null), created_at (timestamptz default now())
       - profiles: id, household_id (fk), name, avatar (text nullable), maturity_level (text default 'adult' check in kids/teen/adult), pin_hash (text nullable), created_at
       - tracked_titles: id, household_id (fk), tmdb_id (int not null), media_type (text check in tv/movie), added_at (timestamptz default now()), unique(household_id, tmdb_id)
       - schedule_entries: id, household_id (fk), profile_id (fk), tracked_title_id (fk), weekday (int check 0-6), slot_order (int), enabled (boolean default true), unique(profile_id, weekday, slot_order)
       - tv_progress: id, profile_id (fk), tracked_title_id (fk), season_number (int default 1), episode_number (int default 1), updated_at (timestamptz default now()), unique(profile_id, tracked_title_id)
       - episode_blurbs: id, series_tmdb_id (int), season_number (int), episode_number (int), blurb_text (text), source (text check in tmdb_truncate/ai), updated_at (timestamptz default now()), unique(series_tmdb_id, season_number, episode_number)
    3. Add all indexes from context section
    4. Add ON DELETE CASCADE for foreign keys where appropriate (profiles cascade from household, etc.)
  </action>
  <verify>cat web/supabase/migrations/*.sql shows all 6 tables with correct structure</verify>
  <done>Migration file exists with households, profiles, tracked_titles, schedule_entries, tv_progress, episode_blurbs tables and all indexes</done>
</task>

<task type="auto">
  <name>Task 2: Generate TypeScript types from schema</name>
  <files>web/lib/database.types.ts</files>
  <action>
    1. Create TypeScript types manually matching the schema (Supabase codegen requires live DB connection)
    2. Create Database interface with public schema containing Tables
    3. Each table has Row, Insert, Update types
    4. Export type aliases for easy import: Household, Profile, TrackedTitle, ScheduleEntry, TvProgress, EpisodeBlurb
    5. Add MaturityLevel type as 'kids' | 'teen' | 'adult'
    6. Add MediaType type as 'tv' | 'movie'
    7. Add BlurbSource type as 'tmdb_truncate' | 'ai'
  </action>
  <verify>tsc --noEmit in web/ passes without errors on the types file</verify>
  <done>database.types.ts exports Database interface and convenience type aliases for all tables</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file exists in web/supabase/migrations/
- [ ] All 6 tables defined with correct columns and constraints
- [ ] All indexes present
- [ ] TypeScript types compile without errors
- [ ] Type aliases exported for convenience
</verification>

<success_criteria>
- Migration file ready to apply to Supabase
- TypeScript types match schema exactly
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-model/02-01-SUMMARY.md`
</output>
