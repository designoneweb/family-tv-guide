---
phase: 05-schedule-system
plan: 03
type: execute
---

<objective>
Build the "Tonight" view - the core value page showing what's scheduled for today.

Purpose: Fast "What are we watching tonight?" - displays current day's scheduled titles with poster art.
Output: Tonight page at `/app/tonight` (or `/app` home) showing today's schedule with title cards.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/05-schedule-system/05-01-PLAN.md
@.planning/phases/05-schedule-system/05-02-PLAN.md

# UI patterns to follow:
@web/app/app/library/library-client.tsx
@web/components/title-card.tsx

**Core value from PROJECT.md:**
"Fast 'What are we watching tonight?' â€” the Guide page must load quickly and show exactly what's scheduled with the next episode ready to watch."

**Tech stack available:** Next.js 16, shadcn/ui, Tailwind, TitleCard component, ProfileContext
**Established patterns:**
- TitleCard with poster, title, year, providers
- ProfileGuard for profile requirement
- Client-side fetch with loading/error states
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Tonight page with current day's schedule</name>
  <files>web/app/app/tonight/page.tsx, web/app/app/tonight/tonight-client.tsx</files>
  <action>
Create the Tonight view:

**page.tsx** (server component):
- Import ProfileGuard
- Render TonightClient within ProfileGuard

**tonight-client.tsx** (client component):
- Use ProfileContext to get current profile ID
- Calculate current weekday: `new Date().getDay()` (0=Sunday, matches DB)
- Fetch today's schedule: GET /api/schedule?profileId={profileId}
- Extract entries for current weekday from response
- Display as art-forward title cards in a grid

Layout:
- Header: "Tonight" with current date (e.g., "Tonight - Sunday, Jan 19")
- Subtitle: "{count} shows scheduled"
- Grid of TitleCard components (reuse from library)
  - Need to enrich with TMDB data (title, poster, year, providers)
  - Create API endpoint or fetch in parallel

Enrichment approach:
- Schedule entries only have tracked_title_id
- Need to fetch TMDB details for display
- Option A: Modify /api/schedule to return enriched data (join with tracked_titles, fetch TMDB)
- Option B: Fetch schedule, then fetch /api/library to get enriched library, match by tracked_title_id

Use Option A (cleaner): Modify /api/schedule to include TMDB metadata in response.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>Tonight page shows current day's scheduled titles with poster art and title info</done>
</task>

<task type="auto">
  <name>Task 2: Enrich schedule API response with TMDB data</name>
  <files>web/app/api/schedule/route.ts</files>
  <action>
Update GET /api/schedule to return enriched entries:

Current response: `{ schedule: { [weekday]: ScheduleEntry[] } }`

Enhanced response:
```typescript
{
  schedule: {
    [weekday: number]: EnrichedScheduleEntry[]
  }
}

interface EnrichedScheduleEntry {
  id: string;
  weekday: number;
  slotOrder: number;
  enabled: boolean;
  // From tracked_titles join:
  trackedTitleId: string;
  tmdbId: number;
  mediaType: 'tv' | 'movie';
  // From TMDB fetch:
  title: string;
  posterPath: string | null;
  year: string;
  providers: { name: string; logoPath: string }[];
}
```

Implementation:
1. Join schedule_entries with tracked_titles to get tmdb_id, media_type
2. Batch fetch TMDB details (like library API does)
3. Batch fetch providers (limit to 20 like library)
4. Return enriched entries

Follow pattern from web/app/api/library/route.ts for TMDB enrichment.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>Schedule API returns enriched entries with title, poster, year, providers</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation link to Tonight page</name>
  <files>web/app/app/layout.tsx</files>
  <action>
Add Tonight to the app navigation:

Check current navigation structure in layout.tsx and add:
- "Tonight" link to /app/tonight (or make it the default /app page)
- Consider making Tonight the default landing after profile selection

If layout has a nav component, add link there.
If no nav exists yet, add simple header nav with links:
- Tonight (/app/tonight) - primary
- Library (/app/library)
- Schedule (/app/schedule)
- Profiles (/app/profiles)

Use Button variant="ghost" or Link styling consistent with the app.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>Tonight page accessible from app navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Tonight page showing current day's scheduled titles with art-forward display</what-built>
  <how-to-verify>
    1. Ensure you have titles added to today's schedule (from schedule page)
    2. Run: `cd web && npm run dev`
    3. Visit: http://localhost:3000/app/tonight
    4. Verify page shows "Tonight - [current day/date]"
    5. Verify scheduled titles display with posters, titles, years
    6. Verify streaming providers show on cards (if available)
    7. Verify empty state shows appropriate message if nothing scheduled
    8. Verify navigation links work (Tonight, Library, Schedule)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] Tonight page displays current day's schedule
- [ ] Titles show with posters and metadata
- [ ] Navigation to Tonight page works
- [ ] Human verification approved
</verification>

<success_criteria>

- Tonight page at /app/tonight shows today's schedule
- Art-forward display with TitleCard components
- Enriched with TMDB metadata and providers
- Navigation accessible from app layout
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-schedule-system/05-03-SUMMARY.md` including:

# Phase 5 Complete: Schedule System

**Plan 1 (05-01):** Schedule service + API routes
**Plan 2 (05-02):** Schedule management UI (week view, add/reorder/remove)
**Plan 3 (05-03):** Tonight view (current day guide)

**Key files created:**
- web/lib/services/schedule.ts
- web/app/api/schedule/* - API routes
- web/app/app/schedule/* - Schedule management page
- web/app/app/tonight/* - Tonight view page

Ready for Phase 6: Progress Tracking (episode tracking per profile per series)
</output>
