---
phase: 05-schedule-system
plan: 01
type: execute
---

<objective>
Create schedule service layer and API routes for managing per-profile weekly TV schedules.

Purpose: Foundation for schedule management - CRUD operations for assigning titles to weekdays with slot ordering.
Output: Schedule service (`lib/services/schedule.ts`) and API routes for schedule operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key prior work:
@.planning/phases/04-library-management/04-01-SUMMARY.md

# Existing patterns to follow:
@web/lib/services/library.ts
@web/lib/services/profile.ts

# Database types:
@web/lib/database.types.ts

# Schema reference (schedule_entries table):
# - id, household_id, profile_id, tracked_title_id, weekday (0-6), slot_order, enabled
# - UNIQUE (profile_id, weekday, slot_order)
# - RLS policies already exist from Phase 2

**Tech stack available:** Next.js 16, Supabase, TypeScript
**Established patterns:** Service layer with Result type, validation helpers, upsert for duplicates
**Constraining decisions:**
- Phase 02-02: RLS policies require household_id for schedule_entries
- Phase 04-01: Library service pattern (Result type, validation, error handling)
- PROJECT.md: Per-profile schedules (not household-wide)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schedule service with CRUD operations</name>
  <files>web/lib/services/schedule.ts</files>
  <action>
Create schedule service following the library.ts pattern with these functions:

1. `addToSchedule(supabase, data: { profileId, trackedTitleId, weekday, householdId })` - Adds title to a weekday
   - Auto-calculate slot_order as max(slot_order) + 1 for that profile+weekday
   - Return the created entry

2. `removeFromSchedule(supabase, entryId)` - Removes entry by ID
   - Other slots' order remains (gaps are fine)

3. `getScheduleForDay(supabase, profileId, weekday)` - Get entries for a specific day
   - Order by slot_order ascending
   - Return array of ScheduleEntry

4. `getWeekSchedule(supabase, profileId)` - Get all 7 days for a profile
   - Return object keyed by weekday (0-6)
   - Each day is array of ScheduleEntry ordered by slot_order

5. `reorderSlot(supabase, entryId, newSlotOrder)` - Move entry to new position
   - Shift other entries to make room (increment slots >= newSlotOrder)
   - Update target entry to newSlotOrder

6. `moveToDay(supabase, entryId, newWeekday)` - Move entry to different day
   - Remove from current day (delete)
   - Add to new day at end (max slot_order + 1)

Use Result type pattern: `{ data: T; error: null } | { data: null; error: ScheduleServiceError }`

Validation:
- weekday must be 0-6
- profileId, trackedTitleId, householdId required where applicable
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>Schedule service exports all 6 functions with proper typing, follows established patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create schedule API routes</name>
  <files>web/app/api/schedule/route.ts, web/app/api/schedule/[id]/route.ts, web/app/api/schedule/reorder/route.ts</files>
  <action>
Create API routes for schedule operations:

**GET /api/schedule** - Get week schedule for current profile
- Query param: profileId (required)
- Returns: { schedule: { [weekday: number]: ScheduleEntry[] } }
- 400 if no profileId, 500 on error

**POST /api/schedule** - Add title to schedule
- Body: { profileId, trackedTitleId, weekday, householdId }
- Returns: { entry: ScheduleEntry }
- 400 for validation errors, 500 on error

**DELETE /api/schedule/[id]** - Remove entry from schedule
- Path param: id (entry ID)
- Returns: { deleted: true }
- 404 if not found, 500 on error

**PATCH /api/schedule/[id]** - Update entry (reorder or move day)
- Path param: id (entry ID)
- Body: { slotOrder?: number, weekday?: number }
- If slotOrder provided: reorder within day
- If weekday provided: move to different day
- Returns: { entry: ScheduleEntry }
- 400 for validation, 500 on error

Follow pattern from web/app/api/library/* routes for error handling and Supabase client usage.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>All 4 API route files created, proper HTTP methods, validation, error responses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] Schedule service exports all 6 functions
- [ ] API routes handle all CRUD operations
- [ ] Result type pattern consistent with library service
</verification>

<success_criteria>

- Schedule service created with full CRUD + reorder operations
- API routes created for client access
- TypeScript compiles without errors
- Patterns consistent with existing library service
</success_criteria>

<output>
After completion, create `.planning/phases/05-schedule-system/05-01-SUMMARY.md`
</output>
