---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Configure Supabase Auth with SSR patterns for cookie-based sessions in Next.js App Router.

Purpose: Establish secure authentication foundation that all protected routes depend on.
Output: Supabase client utilities (server/browser), auth middleware, and session handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**From PROJECT.md:**
- Auth: Supabase SSR with cookie-based sessions
- RLS from day one (secure foundation)

**From SPEC.md:**
- (app) routes are authenticated + dynamic when cookies/session are read
- Supabase RLS is the intended mechanism for row-level authorization

**Supabase SSR pattern (Next.js App Router):**
- Use @supabase/ssr package (not @supabase/auth-helpers-nextjs which is deprecated)
- Create server client for Server Components and Route Handlers
- Create browser client for Client Components
- Middleware refreshes session on every request
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase packages and create client utilities</name>
  <files>web/package.json, web/lib/supabase/server.ts, web/lib/supabase/client.ts, web/.env.local.example</files>
  <action>
1. Install packages: `npm install @supabase/supabase-js @supabase/ssr`

2. Create web/lib/supabase/server.ts:
   - Export `createClient()` function that creates server-side Supabase client
   - Use `createServerClient` from @supabase/ssr
   - Handle cookies using Next.js `cookies()` from 'next/headers'
   - Pattern: read cookies in get(), set cookies in set() with proper options

3. Create web/lib/supabase/client.ts:
   - Export `createClient()` function for browser-side client
   - Use `createBrowserClient` from @supabase/ssr
   - Reads NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY

4. Create web/.env.local.example with required variables:
   ```
   NEXT_PUBLIC_SUPABASE_URL=your-project-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   ```

Note: Do NOT create actual .env.local - user will copy from example and fill in their values.
  </action>
  <verify>TypeScript compiles without errors: cd web && npx tsc --noEmit</verify>
  <done>Supabase client utilities created for server and browser contexts</done>
</task>

<task type="auto">
  <name>Task 2: Create auth middleware for session refresh</name>
  <files>web/middleware.ts, web/lib/supabase/middleware.ts</files>
  <action>
1. Create web/lib/supabase/middleware.ts:
   - Export `updateSession(request)` function
   - Create Supabase client using `createServerClient` with request/response cookie handling
   - Call `supabase.auth.getUser()` to refresh session
   - Return the response with updated cookies

2. Create web/middleware.ts at project root:
   - Import and call `updateSession` from lib/supabase/middleware
   - Configure matcher to run on all routes EXCEPT:
     - _next/static, _next/image, favicon.ico
     - Public assets (images, etc.)
   - Matcher pattern: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`

This middleware runs on every request, keeping the session fresh via cookies.
  </action>
  <verify>npm run dev starts without middleware errors, no console warnings about cookies</verify>
  <done>Auth middleware refreshes session on every request</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] `npx tsc --noEmit` passes with no type errors
- [ ] middleware.ts exists at web/ root
- [ ] lib/supabase/ contains server.ts, client.ts, middleware.ts
- [ ] .env.local.example documents required variables
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Supabase client pattern matches @supabase/ssr documentation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
