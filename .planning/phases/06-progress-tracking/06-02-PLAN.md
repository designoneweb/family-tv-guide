---
phase: 06-progress-tracking
plan: 02
type: execute
---

<objective>
Enhance the Tonight view to display current episode information for TV shows and enable "Mark Watched" functionality.

Purpose: Let users see which episode is next for each scheduled show and quickly advance their progress after watching.
Output: Tonight view cards showing episode info (S2E5: "Episode Title"), with Mark Watched button that advances progress.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-template.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan context:**
@.planning/phases/06-progress-tracking/06-01-SUMMARY.md

**Existing UI to enhance:**
@web/app/app/tonight/tonight-client.tsx
@web/components/title-card.tsx
@web/app/api/schedule/route.ts

**New backend from 06-01:**
@web/lib/services/progress.ts
@web/app/api/progress/route.ts
@web/lib/tmdb/details.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich schedule API with progress data</name>
  <files>web/app/api/schedule/route.ts</files>
  <action>
Modify GET /api/schedule to include progress information for TV shows:

1. After fetching schedule entries (existing code), fetch progress for all TV entries:
   - Filter entries where mediaType === 'tv'
   - Call progress API or service to get progress for each tracked_title_id
   - Join progress data (season_number, episode_number) into enriched entries

2. For each TV entry with progress, fetch episode info from TMDB:
   - Use getTVEpisode(tmdbId, seasonNumber, episodeNumber) from details.ts
   - Add to enriched entry: currentEpisode: { season, episode, title, stillPath } | null
   - For movies: currentEpisode = null (movies don't have episodes)

3. For TV shows WITHOUT existing progress:
   - Initialize default progress as S1E1
   - Include this in response (client will create progress on first "mark watched")

Update EnrichedScheduleEntry type to include:
- currentEpisode: { season: number; episode: number; title: string; stillPath: string | null } | null

Keep backwards compatibility - existing fields remain unchanged.
  </action>
  <verify>
curl localhost:3000/api/schedule?profileId=XXX (with valid auth)
- Returns schedule with currentEpisode for TV entries
- Movies have currentEpisode: null
TypeScript: cd web && npx tsc --noEmit
  </verify>
  <done>Schedule API returns currentEpisode data for TV shows, null for movies</done>
</task>

<task type="auto">
  <name>Task 2: Update Tonight view to display episode info</name>
  <files>web/app/app/tonight/tonight-client.tsx, web/components/title-card.tsx</files>
  <action>
1. Update EnrichedScheduleEntry interface in tonight-client.tsx to include currentEpisode field.

2. Modify TitleCard component to accept optional episode info:
   - Add prop: currentEpisode?: { season: number; episode: number; title: string; stillPath: string | null }
   - Display below title: "S{season}E{episode}: {title}" in muted text
   - Only show for TV shows (when currentEpisode is not null)

3. Pass currentEpisode from tonight-client.tsx to TitleCard for each entry.

4. Style consideration:
   - Episode info should be secondary to title/poster
   - Use text-sm text-muted-foreground for episode line
   - Format: "S1E5: The One with the Embryos"
  </action>
  <verify>cd web && npm run dev, visit /app/tonight, see episode info on TV show cards</verify>
  <done>Tonight view shows current episode for each TV show in schedule</done>
</task>

<task type="auto">
  <name>Task 3: Add Mark Watched button to TitleCard</name>
  <files>web/components/title-card.tsx, web/app/app/tonight/tonight-client.tsx</files>
  <action>
1. Add Mark Watched button to TitleCard:
   - Only show for TV shows (when currentEpisode is not null)
   - Use a simple check icon (CheckCircle from lucide-react) button
   - Position: bottom of card, or as an overlay action
   - On click: call onMarkWatched callback

2. Add props to TitleCard:
   - onMarkWatched?: () => void
   - trackedTitleId?: string (needed for API call)
   - isAdvancing?: boolean (loading state)

3. In tonight-client.tsx:
   - Track loading state per entry (advancingIds: Set<string>)
   - Create handleMarkWatched(entry) function:
     a. Add entry.trackedTitleId to advancingIds
     b. Fetch TV details to get total episodes/seasons (for advance logic)
     c. PATCH /api/progress with action: 'advance', totalEpisodesInSeason, totalSeasons
     d. On success: update local entry.currentEpisode with new values
     e. Remove from advancingIds
   - Pass onMarkWatched and isAdvancing to each TitleCard

4. Show optimistic UI:
   - Disable button while advancing
   - Show spinner or check animation
   - Update episode display immediately on success
  </action>
  <verify>cd web && npm run dev, click Mark Watched on a TV show, see episode number advance</verify>
  <done>Mark Watched button advances episode and updates display without page reload</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Tonight view with episode progress display and Mark Watched functionality</what-built>
  <how-to-verify>
    1. Run: cd web && npm run dev
    2. Visit: http://localhost:3000/app/tonight
    3. Verify: TV shows display current episode (e.g., "S1E1: Pilot")
    4. Click: Mark Watched button on a TV show
    5. Confirm: Episode advances (S1E1 â†’ S1E2), button shows loading state during advance
    6. Refresh: Page shows updated episode (persisted to database)
    7. Check: Movies do not show episode info or Mark Watched button
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] Schedule API returns currentEpisode for TV shows
- [ ] Tonight view displays episode info on TV cards
- [ ] Mark Watched advances progress and updates UI
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verified Tonight view functionality
- No TypeScript errors
- Episode tracking visible and Mark Watched working
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-tracking/06-02-SUMMARY.md` with:

---
phase: 06-progress-tracking
plan: 02
subsystem: ui
tags: [tonight, progress, mark-watched, episode-display]

requires:
  - phase: 06-01
    provides: Progress service and API routes
  - phase: 05-03
    provides: Tonight view foundation
provides:
  - Episode info display on Tonight view
  - Mark Watched functionality
affects: [episode-grid, schedule-view]

tech-stack:
  added: []
  patterns:
    - Optimistic UI updates with loading states
    - TMDB data fetching for episode metadata

key-files:
  modified:
    - web/app/api/schedule/route.ts
    - web/app/app/tonight/tonight-client.tsx
    - web/components/title-card.tsx

key-decisions: []
patterns-established:
  - "Mark Watched pattern with progress advance"
issues-created: []
duration: Xmin
completed: YYYY-MM-DD
---

[Summary content per template]
</output>
