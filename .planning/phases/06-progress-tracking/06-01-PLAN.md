---
phase: 06-progress-tracking
plan: 01
type: execute
---

<objective>
Build the backend foundation for episode progress tracking: TMDB episode API integration, progress service, and API routes.

Purpose: Enable tracking which episode each profile is on for each TV show, with database CRUD operations exposed via API.
Output: TMDB episode types/functions, progress service with get/set/advance operations, and /api/progress routes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/05-schedule-system/05-03-SUMMARY.md

**Existing patterns to follow:**
@web/lib/tmdb/details.ts
@web/lib/tmdb/types.ts
@web/lib/services/schedule.ts
@web/lib/database.types.ts
@web/app/api/schedule/route.ts

**Database schema reference:**
The tv_progress table already exists with columns: id, profile_id, tracked_title_id, season_number, episode_number, updated_at.
RLS policies are already in place (Users can view/insert/update/delete progress in own household).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TMDB episode types and API functions</name>
  <files>web/lib/tmdb/types.ts, web/lib/tmdb/details.ts</files>
  <action>
Add TypeScript types for TMDB season and episode responses to types.ts:
- TMDBSeason: id, name, overview, poster_path, season_number, episodes array
- TMDBEpisode: id, name, overview, still_path, episode_number, season_number, air_date, runtime, vote_average

Add two new functions to details.ts following existing patterns:
- getTVSeason(seriesId: number, seasonNumber: number): Promise<TMDBSeason | null>
  Endpoint: /tv/{series_id}/season/{season_number}
- getTVEpisode(seriesId: number, seasonNumber: number, episodeNumber: number): Promise<TMDBEpisode | null>
  Endpoint: /tv/{series_id}/season/{season_number}/episode/{episode_number}

Follow the 404-returns-null pattern established in getTVDetails/getMovieDetails.
  </action>
  <verify>TypeScript compiles without errors: cd web && npx tsc --noEmit</verify>
  <done>TMDBSeason and TMDBEpisode types exported, getTVSeason and getTVEpisode functions available</done>
</task>

<task type="auto">
  <name>Task 2: Create progress service</name>
  <files>web/lib/services/progress.ts</files>
  <action>
Create progress.ts following the pattern in schedule.ts (Result types, validation, async operations):

Types:
- ProgressResult<T> = { data: T; error: null } | { data: null; error: ProgressServiceError }
- ProgressWithTitle: TvProgress + tmdb_id and media_type from joined tracked_titles

Functions:
1. getProgress(supabase, profileId, trackedTitleId): Get current progress for a specific show
2. getProgressForProfile(supabase, profileId): Get all progress entries for a profile (for batch display)
3. setProgress(supabase, profileId, trackedTitleId, seasonNumber, episodeNumber): Set/upsert progress
4. advanceEpisode(supabase, profileId, trackedTitleId, totalEpisodesInSeason, totalSeasons):
   - Get current progress
   - If episode < totalEpisodesInSeason: increment episode
   - Else if season < totalSeasons: increment season, reset episode to 1
   - Else: return current (show complete)
   - Upsert and return new progress

Use Supabase's .upsert() with onConflict: 'profile_id,tracked_title_id' for setProgress.
Include updated_at: new Date().toISOString() on all writes.
  </action>
  <verify>TypeScript compiles: cd web && npx tsc --noEmit</verify>
  <done>Progress service exports all 4 functions with proper typing</done>
</task>

<task type="auto">
  <name>Task 3: Create progress API routes</name>
  <files>web/app/api/progress/route.ts</files>
  <action>
Create /api/progress route following patterns from /api/schedule:

GET /api/progress?profileId=X
- Returns all progress entries for the profile
- Each entry includes tmdb_id from joined tracked_titles for client-side TMDB lookups
- Returns { progress: ProgressWithTitle[] }

POST /api/progress
- Body: { profileId, trackedTitleId, seasonNumber, episodeNumber }
- Upserts progress using setProgress service
- Returns { progress: TvProgress }

PATCH /api/progress
- Body: { profileId, trackedTitleId, action: 'advance', totalEpisodesInSeason, totalSeasons }
- Advances to next episode using advanceEpisode service
- Returns { progress: TvProgress }

All routes: validate profileId exists, return 401 if no session, 400 for validation errors, 500 for unexpected.
Use createClient from @/lib/supabase/server.
  </action>
  <verify>
curl test (requires dev server + auth):
1. cd web && npm run dev (in background)
2. Check route file exists and exports GET, POST, PATCH handlers
TypeScript compiles: cd web && npx tsc --noEmit
  </verify>
  <done>GET returns progress array, POST upserts, PATCH advances episode. All typed correctly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes with no errors
- [ ] `cd web && npm run build` succeeds
- [ ] TMDB functions getTVSeason and getTVEpisode are exported
- [ ] Progress service exports getProgress, getProgressForProfile, setProgress, advanceEpisode
- [ ] API route exports GET, POST, PATCH handlers
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Progress tracking backend is ready for UI consumption
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-tracking/06-01-SUMMARY.md` with:

---
phase: 06-progress-tracking
plan: 01
subsystem: api
tags: [progress, tmdb, episode, backend]

requires:
  - phase: 03-02
    provides: TMDB detail fetching pattern
  - phase: 05-01
    provides: Service layer pattern
provides:
  - TMDB episode/season API functions
  - Progress service with CRUD operations
  - Progress API routes for client consumption
affects: [tonight-view, episode-grid]

tech-stack:
  added: []
  patterns:
    - Progress tracking via upsert with onConflict
    - Episode advancement logic

key-files:
  created:
    - web/lib/services/progress.ts
    - web/app/api/progress/route.ts
  modified:
    - web/lib/tmdb/types.ts
    - web/lib/tmdb/details.ts

key-decisions: []
patterns-established:
  - "Progress service with advance logic"
issues-created: []
duration: Xmin
completed: YYYY-MM-DD
---

[Summary content per template]
</output>
