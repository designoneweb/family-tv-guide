---
phase: 04-library-management
plan: 01
type: execute
---

<objective>
Create library service layer for tracked_titles CRUD operations.

Purpose: Establish the data access layer for adding/removing titles to household library, following the established service pattern.
Output: Library service with add, remove, list, and check operations, plus API route for library status checks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/03-tmdb-integration/03-02-SUMMARY.md

# Existing patterns to follow:
@web/lib/services/profile.ts
@web/lib/database.types.ts

# TMDB integration available:
@web/lib/tmdb/types.ts

**Tech stack available:** Next.js 16, Supabase, TanStack Query, TypeScript, shadcn/ui
**Established patterns:** Service layer with Result types, validation functions, null-safe returns
**Constraining decisions:**
- Phase 02-01: UUID primary keys, ON DELETE CASCADE
- Phase 02-02: RLS policies on tracked_titles require household membership
- Phase 03-02: Return null for 404s instead of throwing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create library service with CRUD operations</name>
  <files>web/lib/services/library.ts</files>
  <action>
Create library service following the profile.ts pattern:

1. Types:
   - `AddTitleData { householdId, tmdbId, mediaType }`
   - `LibraryServiceError { message, code? }`
   - `LibraryResult<T>` union type for success/error

2. Validation:
   - `validateAddData()` - check householdId present, tmdbId > 0, mediaType is 'tv' or 'movie'

3. Service functions:
   - `addTitle(supabase, data: AddTitleData): LibraryResult<TrackedTitle>` - insert with upsert to handle duplicates gracefully (return existing if already added)
   - `removeTitle(supabase, id: string): LibraryResult<{ deleted: true }>` - delete by tracked_title id
   - `getLibrary(supabase, householdId: string, mediaType?: MediaType): LibraryResult<TrackedTitle[]>` - list all titles, optional filter by type
   - `isInLibrary(supabase, householdId: string, tmdbId: number): LibraryResult<{ inLibrary: boolean; titleId?: string }>` - check if tmdb_id exists

Use upsert for addTitle with `onConflict: 'household_id,tmdb_id'` to avoid duplicate errors - if title exists, just select and return it.

Follow profile.ts error handling: console.error, return { data: null, error: { message, code } }.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>Library service exports addTitle, removeTitle, getLibrary, isInLibrary with proper typing</done>
</task>

<task type="auto">
  <name>Task 2: Add API route for library status check</name>
  <files>web/app/api/library/check/route.ts</files>
  <action>
Create GET endpoint `/api/library/check?tmdbId=123` that returns whether a title is in the current user's household library.

Implementation:
1. Get authenticated user from Supabase server client
2. Get user's household_id via getCurrentHousehold()
3. Call isInLibrary(supabase, householdId, tmdbId)
4. Return JSON: `{ inLibrary: boolean, titleId?: string }`

Authentication check: Return 401 if no user session.
Validation: Return 400 if tmdbId missing or not a valid number.

Import createClient from '@/lib/supabase/server' for server-side auth.
Import getCurrentHousehold from '@/lib/services/household'.
  </action>
  <verify>
Build passes: `cd web && npm run build`
  </verify>
  <done>GET /api/library/check?tmdbId=X returns { inLibrary, titleId? } for authenticated users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] library.ts exports all 4 functions
- [ ] API route handles auth and validation errors
</verification>

<success_criteria>

- Library service created with full CRUD operations
- API route for library status check works
- Types match database.types.ts TrackedTitle
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-library-management/04-01-SUMMARY.md`
</output>
