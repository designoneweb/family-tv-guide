---
phase: 04-library-management
plan: 02
type: execute
---

<objective>
Build search UI for finding and adding titles to the library.

Purpose: Enable users to search TMDB and add TV shows/movies to their household library with visual feedback.
Output: Search page with results grid, title cards with add-to-library action.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/04-library-management/04-01-SUMMARY.md

# Existing patterns:
@web/app/app/profiles/page.tsx
@web/components/profile-card.tsx

# TMDB types for search results:
@web/lib/tmdb/types.ts
@web/lib/tmdb/images.ts

# API routes available:
@web/app/api/tmdb/search/route.ts

**Tech stack:** Next.js 16, TanStack Query, shadcn/ui, Tailwind
**Patterns:** Server/client component split, async data fetching
**Decisions:**
- Server-side only TMDB calls via API route
- Combined multi-search sorts by popularity
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search page with input and results</name>
  <files>web/app/app/library/search/page.tsx, web/app/app/library/search/search-client.tsx</files>
  <action>
Create search page at `/app/library/search`:

**page.tsx (server component):**
- Simple wrapper that renders SearchClient
- Include ProfileGuard for route protection

**search-client.tsx (client component):**
1. State: query string, debouncedQuery, results array, loading state
2. Input: shadcn Input component with search icon, placeholder "Search TV shows and movies..."
3. Debounce: 300ms delay before fetching (use setTimeout/clearTimeout pattern or useDebouncedValue)
4. Fetch: When debouncedQuery changes, call `/api/tmdb/search?query=X&type=multi`
5. Results grid: 3-col grid on desktop, 2-col tablet, 1-col mobile
6. Each result: Render SearchResultCard (create inline or separate)

**SearchResultCard (inline or separate):**
- Poster image using getPosterUrl() with fallback placeholder div
- Title (name for TV, title for movie)
- Year from first_air_date or release_date (extract year)
- Media type badge (TV Show / Movie)
- Add button that calls library service

For "Add" action:
- Use fetch POST to new `/api/library/add` route (create in this task)
- Show loading state on button
- On success, update button to "In Library" (disabled)
- Check if already in library using `/api/library/check?tmdbId=X` on mount

**API route web/app/api/library/add/route.ts:**
- POST with body { tmdbId, mediaType }
- Get user's household, call addTitle service
- Return the created TrackedTitle

Use 'use client' directive for search-client.tsx.
Import getPosterUrl from '@/lib/tmdb/images'.
  </action>
  <verify>
`cd web && npm run build` passes
Navigate to /app/library/search shows search input
  </verify>
  <done>Search page renders with input, fetches results on query change, displays result cards</done>
</task>

<task type="auto">
  <name>Task 2: Create reusable TitleCard component</name>
  <files>web/components/title-card.tsx</files>
  <action>
Extract and enhance the search result card into a reusable TitleCard component:

**Props interface:**
```typescript
interface TitleCardProps {
  tmdbId: number;
  mediaType: 'tv' | 'movie';
  title: string;
  posterPath: string | null;
  year?: string;
  inLibrary?: boolean;
  onAdd?: () => void;
  onRemove?: () => void;
  isLoading?: boolean;
}
```

**Component:**
1. Aspect ratio container for poster (2:3 ratio)
2. Next.js Image for poster with fallback div (gray bg with film icon)
3. Title below poster, truncate with ellipsis if too long
4. Year and media type badge row
5. Action button:
   - If inLibrary && onRemove: "Remove" button (destructive variant)
   - If !inLibrary && onAdd: "Add" button (default variant)
   - If isLoading: show spinner/disabled
   - If inLibrary && !onRemove: "In Library" text (no button)

Use shadcn Button component.
Use Next.js Image with unoptimized prop for external TMDB images.
  </action>
  <verify>`cd web && npx tsc --noEmit` passes</verify>
  <done>TitleCard component handles add/remove states with proper styling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Search page with TMDB integration and add-to-library functionality</what-built>
  <how-to-verify>
    1. Run: `cd web && npm run dev`
    2. Visit: http://localhost:3000/app/library/search
    3. Type "Breaking Bad" in search
    4. Verify: Results appear after brief delay (debounce)
    5. Verify: Each result shows poster, title, year, media type
    6. Click "Add" on a result
    7. Verify: Button changes to "In Library"
    8. Refresh page, search again
    9. Verify: Previously added title shows "In Library" state
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] Search input triggers API call
- [ ] Results display with posters
- [ ] Add button successfully adds to library
- [ ] Already-added titles show correct state
</verification>

<success_criteria>

- Search page accessible at /app/library/search
- TMDB search results display in grid
- Add to library works and persists
- TitleCard component is reusable
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/04-library-management/04-02-SUMMARY.md`
</output>
