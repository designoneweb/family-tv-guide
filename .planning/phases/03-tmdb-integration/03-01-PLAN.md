---
phase: 03-tmdb-integration
plan: 01
type: execute
---

<objective>
Set up TMDB API client and implement TV/movie search functionality.

Purpose: Enable searching for titles to add to household library with server-side API protection.
Output: Working TMDB client with search endpoints that return typed results.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tmdb-integration/DISCOVERY.md

# Prior phase context (from frontmatter):
@.planning/phases/02-data-model/02-01-SUMMARY.md

**Tech stack available:**
- Next.js 16.1.3 with App Router
- Supabase client configured
- Service layer pattern established in lib/services/

**Established patterns:**
- Server components for data fetching
- Service functions return typed data
- Environment variables in .env.local

**Key files:**
@web/lib/services/household.ts
@web/.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TMDB client with types</name>
  <files>web/lib/tmdb/client.ts, web/lib/tmdb/types.ts, web/.env.local.example</files>
  <action>
Create TMDB client module:

1. **types.ts** - Define TypeScript types for TMDB API responses:
   - `TMDBSearchResult` (TV and movie search results)
   - `TMDBTVSearchResponse` and `TMDBMovieSearchResponse` (paginated responses)
   - Export a `MediaType` that matches database.types.ts ('tv' | 'movie')

2. **client.ts** - Create base fetch wrapper:
   - Read `TMDB_API_KEY` from environment (throw clear error if missing)
   - Create `tmdbFetch<T>(endpoint: string, params?: Record<string, string>)` function
   - Base URL: `https://api.themoviedb.org/3`
   - Add Authorization header with Bearer token
   - Handle response parsing and errors
   - Do NOT add retry logic - keep simple, TMDB limits are generous

3. **Update .env.local.example** - Add `TMDB_API_KEY=your_tmdb_api_key_here`

Avoid: Exposing API key to client, complex retry/caching logic (not needed for this scale).
  </action>
  <verify>TypeScript compiles without errors: `cd web && npx tsc --noEmit`</verify>
  <done>
- tmdb/types.ts exports search response types
- tmdb/client.ts exports tmdbFetch function
- .env.local.example includes TMDB_API_KEY
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement search endpoints</name>
  <files>web/lib/tmdb/search.ts, web/app/api/tmdb/search/route.ts</files>
  <action>
Create search functionality:

1. **search.ts** - Service functions for search:
   - `searchTV(query: string, page?: number): Promise<TMDBTVSearchResponse>`
   - `searchMovies(query: string, page?: number): Promise<TMDBMovieSearchResponse>`
   - `searchMulti(query: string, page?: number)` that searches both and combines
   - Use tmdbFetch internally
   - Set `include_adult=false` and `language=en-US` as defaults

2. **API Route** - Create `/api/tmdb/search` for client access:
   - GET handler accepting `query` and optional `type` ('tv' | 'movie' | 'multi')
   - Validate query is non-empty string
   - Return JSON response with proper error handling
   - Return 400 for missing/invalid query
   - Use the search.ts functions internally

Why API route instead of server action: Search needs to be called from client-side search input with debounce, API route is more appropriate for this pattern.
  </action>
  <verify>
Manual test (requires TMDB_API_KEY in .env.local):
```bash
cd web && npm run dev
# In another terminal:
curl "http://localhost:3000/api/tmdb/search?query=breaking%20bad&type=tv"
```
Should return JSON with search results.
  </verify>
  <done>
- searchTV, searchMovies, searchMulti functions work
- API route returns search results for valid query
- API route returns 400 for empty query
- Results include id, name/title, poster_path, overview
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] API route responds to search queries (manual test)
- [ ] No TMDB API key exposure in client bundles
</verification>

<success_criteria>

- TMDB client configured with typed fetch wrapper
- Search endpoints return paginated results
- API key stays server-side only
- TypeScript types match TMDB response shapes
</success_criteria>

<output>
After completion, create `.planning/phases/03-tmdb-integration/03-01-SUMMARY.md`
</output>
