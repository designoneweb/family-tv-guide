---
phase: 03-tmdb-integration
plan: 02
type: execute
---

<objective>
Implement TMDB metadata fetching, watch providers, and image URL helpers.

Purpose: Complete TMDB integration with all data needed for library and episode display.
Output: Functions to fetch TV/movie details, streaming providers, and build image URLs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tmdb-integration/DISCOVERY.md
@.planning/phases/03-tmdb-integration/03-01-SUMMARY.md

**Tech stack available:**
- TMDB client with typed fetch (from 03-01)
- Search endpoints working

**Key files from prior plans:**
@web/lib/tmdb/client.ts
@web/lib/tmdb/types.ts
@web/lib/tmdb/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add detail types and fetch functions</name>
  <files>web/lib/tmdb/types.ts, web/lib/tmdb/details.ts</files>
  <action>
Extend types and add detail fetching:

1. **Add to types.ts:**
   - `TMDBTVDetails` - Full TV show details (id, name, overview, poster_path, backdrop_path, first_air_date, number_of_seasons, number_of_episodes, status, genres, vote_average)
   - `TMDBMovieDetails` - Full movie details (id, title, overview, poster_path, backdrop_path, release_date, runtime, status, genres, vote_average)
   - `TMDBGenre` - { id: number; name: string }

2. **details.ts** - Create detail functions:
   - `getTVDetails(tmdbId: number): Promise<TMDBTVDetails>`
   - `getMovieDetails(tmdbId: number): Promise<TMDBMovieDetails>`
   - Use tmdbFetch internally
   - Handle not-found gracefully (return null or throw descriptive error)

Details endpoints:
- TV: `/tv/{series_id}`
- Movie: `/movie/{movie_id}`
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>
- TMDBTVDetails and TMDBMovieDetails types defined
- getTVDetails and getMovieDetails functions work
- Proper error handling for invalid IDs
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement watch providers</name>
  <files>web/lib/tmdb/types.ts, web/lib/tmdb/providers.ts</files>
  <action>
Add watch provider functionality:

1. **Add to types.ts:**
   - `TMDBWatchProvider` - { provider_id: number; provider_name: string; logo_path: string }
   - `TMDBWatchProviderResult` - { flatrate?: TMDBWatchProvider[]; rent?: TMDBWatchProvider[]; buy?: TMDBWatchProvider[]; link?: string }
   - `TMDBWatchProvidersResponse` - { id: number; results: Record<string, TMDBWatchProviderResult> }

2. **providers.ts** - Create provider functions:
   - `getTVWatchProviders(tmdbId: number, region?: string): Promise<TMDBWatchProviderResult | null>`
   - `getMovieWatchProviders(tmdbId: number, region?: string): Promise<TMDBWatchProviderResult | null>`
   - Default region to 'US'
   - Return null if no providers for region
   - Extract just the region-specific result from the response

Endpoints:
- TV: `/tv/{series_id}/watch/providers`
- Movie: `/movie/{movie_id}/watch/providers`
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>
- Watch provider types defined
- Functions return streaming providers for US region
- Returns null gracefully when no providers available
  </done>
</task>

<task type="auto">
  <name>Task 3: Create image URL helpers</name>
  <files>web/lib/tmdb/images.ts</files>
  <action>
Create image URL utility functions:

1. **images.ts** - Image URL construction:
   - Define size constants:
     ```typescript
     export const TMDB_IMAGE_SIZES = {
       poster: { small: 'w185', medium: 'w342', large: 'w500' },
       backdrop: { small: 'w300', medium: 'w780', large: 'w1280' },
       still: { small: 'w185', medium: 'w300', large: 'w300' },
       logo: { small: 'w92', medium: 'w154', large: 'w300' },
     } as const;
     ```
   - `getTMDBImageUrl(path: string | null, type: 'poster' | 'backdrop' | 'still' | 'logo', size: 'small' | 'medium' | 'large'): string | null`
     - Return null if path is null
     - Build URL: `https://image.tmdb.org/t/p/{size}/{path}`
   - `getPosterUrl(path: string | null, size?: 'small' | 'medium' | 'large'): string | null` - Convenience wrapper defaulting to medium
   - `getBackdropUrl(path: string | null, size?: 'small' | 'medium' | 'large'): string | null` - Convenience wrapper defaulting to medium
   - `getStillUrl(path: string | null, size?: 'small' | 'medium' | 'large'): string | null` - Convenience wrapper for episode stills
   - `getProviderLogoUrl(path: string | null): string | null` - Always use small size for provider logos

Base URL: `https://image.tmdb.org/t/p`

Avoid: Fetching configuration dynamically - hardcode sizes as they rarely change.
  </action>
  <verify>TypeScript compiles: `cd web && npx tsc --noEmit`</verify>
  <done>
- Image URL helpers return proper URLs
- Returns null for null paths (graceful fallback)
- Size constants available for reference
- Convenience functions for common use cases
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` passes
- [ ] `cd web && npm run build` succeeds
- [ ] All TMDB modules export correctly (details, providers, images)
- [ ] Image URLs generate correctly for valid paths
</verification>

<success_criteria>

- TV and movie detail fetching works with typed responses
- Watch providers return streaming services for US region
- Image URL helpers generate correct URLs
- All functions handle null/missing data gracefully
- Phase 3 complete - TMDB integration ready for library phase
</success_criteria>

<output>
After completion, create `.planning/phases/03-tmdb-integration/03-02-SUMMARY.md`
</output>
